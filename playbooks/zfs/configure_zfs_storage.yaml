---
- name: Configure ZFS storage in Proxmox
  hosts: proxmox_hosts
  become: true

  vars:
    pool_name: "tank"

    # Docker apps - each will get its own dataset
    docker_apps:
      - backups
      - traefik
      - actual
      - paperless
      - immich
      - monitoring
      - n8n
      - dashy

  tasks:
    - name: Check if ZFS pool exists
      ansible.builtin.command:
        cmd: "zpool list {{ pool_name }}"
      register: pool_check
      failed_when: false
      changed_when: false

    - name: Fail if ZFS pool doesn't exist
      ansible.builtin.fail:
        msg: "ZFS pool '{{ pool_name }}' does not exist. Please create it first."
      when: pool_check.rc != 0

    - name: Check which Docker app datasets already exist
      ansible.builtin.command:
        cmd: "zfs list {{ pool_name }}/{{ item }}"
      loop: "{{ docker_apps }}"
      register: app_dataset_checks
      failed_when: false
      changed_when: false

    - name: Create ZFS dataset for each Docker app with properties (if not exists)
      ansible.builtin.command:
        cmd: "zfs create -o compression=lz4 -o atime=off {{ pool_name }}/{{ item.item }}"
      loop: "{{ app_dataset_checks.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ pool_name }}/{{ item.item }}"

    - name: List all created datasets
      ansible.builtin.command:
        cmd: "zfs list -r {{ pool_name }}"
      register: zfs_list
      changed_when: false

    - name: Show storage details
      ansible.builtin.debug:
        msg:
          - "ZFS Docker storage configured successfully!"
          - "Created {{ docker_apps | length }} app datasets directly in {{ pool_name }}"
          - ""
          - "All datasets:"

    - name: Display ZFS datasets
      ansible.builtin.debug:
        var: zfs_list.stdout_lines
