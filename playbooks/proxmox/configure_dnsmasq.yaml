---
- name: Configure dnsmasq on Proxmox for wildcard DNS
  hosts: proxmox_hosts
  become: true

  vars_files:
    - ../../vars/global.yml
    - ../../vars/secrets.yml

  vars:
    dnsmasq_config_dir: /etc/dnsmasq.d
    dns_entries:
      - domain: "varshavskyi.com"
        ip: "192.168.8.222"
        comment: "Main domain to Traefik"
      - domain: "traefik.varshavskyi.com"
        ip: "192.168.8.222"
        comment: "Traefik subdomain"

  tasks:
    - name: Install dnsmasq
      ansible.builtin.apt:
        name: dnsmasq
        state: present
        update_cache: true

    - name: Check if /etc/dnsmasq.d directory exists
      ansible.builtin.file:
        path: "{{ dnsmasq_config_dir }}"
        state: directory
        mode: '0755'

    - name: Enable conf-dir in main dnsmasq.conf
      ansible.builtin.lineinfile:
        path: /etc/dnsmasq.conf
        regexp: '^#?conf-dir=/etc/dnsmasq.d'
        line: 'conf-dir=/etc/dnsmasq.d/,*.conf'
        state: present
        backup: true
      notify: restart dnsmasq

    - name: Configure dnsmasq to listen on all interfaces
      ansible.builtin.lineinfile:
        path: /etc/dnsmasq.conf
        regexp: '^#?interface='
        line: 'interface=vmbr0'
        state: present
        backup: true
      notify: restart dnsmasq

    - name: Configure dnsmasq to bind only to specified interfaces
      ansible.builtin.lineinfile:
        path: /etc/dnsmasq.conf
        regexp: '^#?bind-interfaces'
        line: 'bind-interfaces'
        state: present
        backup: true
      notify: restart dnsmasq

    - name: Set domain-needed option (don't forward plain names)
      ansible.builtin.lineinfile:
        path: /etc/dnsmasq.conf
        regexp: '^#?domain-needed'
        line: 'domain-needed'
        state: present
        backup: true
      notify: restart dnsmasq

    - name: Set bogus-priv option (don't forward reverse lookups for private ranges)
      ansible.builtin.lineinfile:
        path: /etc/dnsmasq.conf
        regexp: '^#?bogus-priv'
        line: 'bogus-priv'
        state: present
        backup: true
      notify: restart dnsmasq

    - name: Create custom DNS configuration file
      ansible.builtin.copy:
        dest: "{{ dnsmasq_config_dir }}/custom-dns.conf"
        mode: '0644'
        content: |
          # Custom DNS entries for homelab
          # Generated by Ansible

          {% for entry in dns_entries %}
          # {{ entry.comment }}
          address=/{{ entry.domain }}/{{ entry.ip }}
          {% endfor %}
        backup: true
      notify: restart dnsmasq

    - name: Disable systemd-resolved if it's running (conflicts with dnsmasq)
      ansible.builtin.systemd:
        name: systemd-resolved
        state: stopped
        enabled: false
      failed_when: false
      register: systemd_resolved_status

    - name: Check if /etc/resolv.conf is a symlink to systemd-resolved
      ansible.builtin.stat:
        path: /etc/resolv.conf
      register: resolv_conf_stat

    - name: Remove systemd-resolved symlink if present
      ansible.builtin.file:
        path: /etc/resolv.conf
        state: absent
      when: resolv_conf_stat.stat.islnk is defined and resolv_conf_stat.stat.islnk

    - name: Create new /etc/resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        mode: '0644'
        content: |
          # DNS configuration
          # Managed by Ansible
          nameserver 127.0.0.1
          nameserver 1.1.1.1
          nameserver 1.0.0.1
      when: resolv_conf_stat.stat.islnk is defined and resolv_conf_stat.stat.islnk

    - name: Enable dnsmasq service
      ansible.builtin.systemd:
        name: dnsmasq
        enabled: true
        state: started

    - name: Flush handlers to restart dnsmasq if needed
      ansible.builtin.meta: flush_handlers

    - name: Wait for dnsmasq to be ready
      ansible.builtin.wait_for:
        port: 53
        delay: 2
        timeout: 30

    - name: Test DNS resolution
      ansible.builtin.command:
        cmd: "dig @127.0.0.1 {{ item }} +short"
      loop:
        - "varshavskyi.com"
        - "traefik.local.varshavskyi.com"
        - "test.varshavskyi.com"
      register: dns_test
      changed_when: false
      failed_when: false

    - name: Display DNS test results
      ansible.builtin.debug:
        msg: |
          dnsmasq has been configured successfully!

          DNS Entries configured:
          {% for entry in dns_entries %}
            {{ entry.domain }} â†’ {{ entry.ip }}
          {% endfor %}

          DNS Resolution Tests:
          {% for result in dns_test.results %}
            {{ result.item }}: {{ result.stdout if result.stdout else 'Failed' }}
          {% endfor %}

          Next steps:
          1. Update your router's DNS to point to this Proxmox server ({{ ansible_default_ipv4.address }})
          2. Or manually configure DNS on client devices to use {{ ansible_default_ipv4.address }}

          To test from another machine:
            dig @{{ ansible_default_ipv4.address }} traefik.local.varshavskyi.com

  handlers:
    - name: restart dnsmasq
      ansible.builtin.systemd:
        name: dnsmasq
        state: restarted
