---
- name: Step 1 - Create LXC container
  ansible.builtin.import_playbook: create_container.yaml

- name: Wait for container initialization
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Wait for container to fully initialize
      ansible.builtin.pause:
        prompt: "Waiting for container to fully initialize..."
        seconds: 15

- name: Verify container is accessible
  hosts: lxc_containers
  gather_facts: false

  tasks:
    - name: Wait for container to be reachable via SSH
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 5
      register: connection_result

    - name: Verify container is responsive
      ansible.builtin.ping:

    - name: Display connection status
      ansible.builtin.debug:
        msg: "Container is up and running! Proceeding with updates..."

- name: Step 2 - Update and upgrade container
  ansible.builtin.import_playbook: update_and_upgrade.yaml

- name: Wait after system updates
  hosts: lxc_containers
  gather_facts: false

  tasks:
    - name: Wait for container to stabilize after updates
      ansible.builtin.pause:
        seconds: 10

    - name: Re-verify container connectivity
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 5

    - name: Display status
      ansible.builtin.debug:
        msg: "System updated successfully! Installing Docker..."

- name: Step 3 - Install Docker
  ansible.builtin.import_playbook: install_docker.yaml
